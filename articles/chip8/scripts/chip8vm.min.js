function Engine(a){this.mainloop=a,this.running=!1}function Keypad(){function a(){for(var a=0;a<d.keys.length;++a)d.keys[a]=!1;document.addEventListener("keydown",b),document.addEventListener("keyup",c)}function b(a){var b=String.fromCharCode(a.which);if(b in e){var c=e[b];d.keys[c]=!0,++d.numPressed}}function c(a){var b=String.fromCharCode(a.which);if(b in e){var c=e[b];d.keys[c]=!1,--d.numPressed,d.callback&&(d.callback(c),d.callback=null)}}var d=this,e={1:1,2:2,3:3,4:12,Q:4,W:5,E:6,R:13,A:7,S:8,D:9,F:14,Z:10,X:0,C:11,V:15};this.keys=new Array(16),this.callback=null,this.numPressed=0,a()}function Game(){function a(){return Date.now()}function b(b){function e(){var b=a(),c=b-o;o=b;for(var e=Math.floor(c*d.instructions_per_second/1e3),g=0;e>g;++g)j.step();for(n+=e;n>=m;)n-=m,j.interrupt(),j.redraw&&(f.draw(j.vram),j.redraw=!1),d.show_fps&&f.drawFPS(p.getFPS()),p.updateFPS(b)}var j=new Chip8(h,f,g,d);j.loadProgram(b);var k=60,l=1e3/k,m=Math.floor(d.instructions_per_second*l/1e3),n=0,o=a();Platform.log("Frame Hz: "+k),Platform.log("Instructions per second: "+d.instructions_per_second),Platform.log("Instructions per frame: "+m);var p=new c;i=new Engine(e),i.start()}function c(){var b=a(),c=0,d=0;this.getFPS=function(){return d},this.updateFPS=function(a){++c;var e=a-b;e>2e3&&(d=Math.round(1e3*c/e),b=a,c=0)}}var d={show_fps:!1,drw_waits_for_vsync:!0,redraw_on_collision:!1,instructions_per_second:840},e=document.getElementById("screen"),f=new Renderer(e,64,32),g=new Sound,h=new Keypad,i=null;this.load=function(a){null!==i&&(i.stop(),i=null),Platform.loadFileAsByteArray(a,b)}}function main(){"use strict";function a(a){$(c).removeClass("selected"),$("#game_browse").addClass("selected"),c="#game_browse";var d=a.target.files[0],e=window.URL.createObjectURL(d);b.load(e)}var b=new Game,c=null,d=["15puzzle","Blinky","Blitz","Brix","Connect4","Guess","Hidden","IBM","Invaders","Kaleid","Maze","Merlin","Missile","Pong","Pong2","Puzzle","Syzygy","Tank","Tetris","Tictac","Ufo","Vbrix","Vers","Wipeoff"];d.forEach(function(a){$("#game_section").append("<a id='"+a+"'class='item'>"+a+"</a>");var d="#"+a;$(d).click(function(){$(c).removeClass("selected"),$(d).addClass("selected"),c=d,b.load("https://dl.dropboxusercontent.com/u/1614913/roms/"+a.toUpperCase())})}),document.getElementById("game_file").addEventListener("change",a,!1)}!function(){"use strict";function a(){}a.log=function(a){console.log(a)},a.requestAnimationFrame=function(a){var b=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||null;b(a)},a.loadFileAsByteArray=function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="arraybuffer",c.onload=function(){b(new Uint8Array(c.response))},c.send()},a.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext,window.Platform=a}(),Engine.prototype.start=function(){var a=this;a.running=!0;var b=function(){a.running===!0&&(a.mainloop(),Platform.requestAnimationFrame(b))};Platform.log("Engine started"),b()},Engine.prototype.stop=function(){this.running=!1,Platform.log("Engine stopped")},Keypad.prototype.waitForKey=function(a){this.callback=a},Keypad.prototype.isAnyKeyPressed=function(){return this.numPressed>0},function(){"use strict";var a=function(a,b,c){function d(){f.canvasOff=document.createElement("canvas"),f.ctxOff=a.getContext("2d"),f.ctx=a.getContext("2d"),f.width=b,f.height=c,f.scale=1,window.addEventListener("resize",e,!1),e(),f.alpha=new Array(f.width*f.height);for(var d=0;d<f.alpha.length;++d)f.alpha[d]=0;f.clear()}function e(){var b=20,c=document.getElementById("display");f.scale=Math.floor((c.clientWidth-b)/f.width),Platform.log("Screen resized: width="+c.clientWidth+" height="+c.clientWidth+" scale="+f.scale),a.width=f.width*f.scale,a.height=f.height*f.scale,f.canvasOff.width=a.width,f.canvasOff.height=a.height,f.ctx.drawImage(f.canvasOff,0,0)}var f=this;this.clear=function(){this.ctxOff.fillStyle="#000000",this.ctxOff.fillRect(0,0,this.width*this.scale,this.height*this.scale)},this.draw=function(a){var b=!1;this.ctxOff.fillStyle="#000000";for(var c=0;c<this.height;++c)for(var d=0;d<this.width;++d){var e=c*this.width+d,f=0!==a[e];b!==f&&(this.ctxOff.fillStyle=f?"#009900":"#000000",b=f),this.ctxOff.fillRect(d*this.scale,c*this.scale,this.scale,this.scale)}this.ctx.drawImage(this.canvasOff,0,0)},this.drawFPS=function(a){this.ctx.save(),this.ctx.fillStyle="#66A3D2",this.ctx.strokeStyle="#000000",this.ctx.strokeText("FPS: "+a,20,10),this.ctx.fillText("FPS: "+a,20,10),this.ctx.restore()},d()};window.Renderer=a}(),function(){"use strict";var a=function(){var a,b,c;Platform.AudioContext&&(a=new Platform.AudioContext,c=a.createGain(),c.connect(a.destination)),this.play=function(){b||(b=a.createOscillator(),b.frequency.value=440,b.type=b.SQUARE,b.connect(c),b.start(0))},this.stop=function(){b&&(b.stop(0),b.disconnect(0),b=null)}};window.Sound=a}(),function(){"use strict";function a(a,b,c,d){var e=new ArrayBuffer(4096);this.memory=new Uint8Array(e),this.stack=new Array(16),this.screenWidth=64,this.screenHeigth=32,this.vram=new Array(this.screenWidth*this.screenWidth),this.redraw=!1,this.pc=512,this.v=new Array(16),this.sp=0,this.i=0,this.rpl=new Array(16),this.delayTimer=0,this.soundTimer=0,this.active=!0,this.drawRoutine=null,this.input=a,this.renderer=b,this.sound=c,this.config=d,this.reset()}var b=!1;a.prototype.reset=function(){function a(){for(var a=0;a<d.memory.length;++a)d.memory[a]=0;for(var b=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128],c=0;c<b.length;++c)d.memory[c]=b[c]}function b(){for(var a=0;a<d.vram.length;++a)d.vram[a]=0;d.redraw=!0}function c(){d.pc=512;for(var a=0;a<d.v.length;++a)d.v[a]=0,d.rpl[a]=0;d.sp=0,d.i=0,d.active=!0,d.delayTimer=0,d.soundTimer=0}var d=this;this.sound.stop(),a(),b(),c()},a.prototype.loadProgram=function(a){this.reset();for(var b=0;b<a.length;++b)this.memory[b+512]=a[b]},a.prototype.interrupt=function(){this.playSound(),this.stepTimers(),null!==this.drawRoutine&&this.performDrawCall(),this.waitForInterrupt=!1},a.prototype.performDrawCall=function(){var a=this.drawRoutine();this.drawRoutine=null,this.redraw=this.config.redraw_on_collision||!a},a.prototype.stepTimers=function(){this.delayTimer>0&&--this.delayTimer,this.soundTimer>0&&--this.soundTimer},a.prototype.playSound=function(){this.soundTimer>0?this.sound.play():this.sound.stop()},a.prototype.step=function(){this.active&&!this.drawRoutine&&this.execute_instruction()},a.prototype.execute_instruction=function(){var a=this.memory[this.pc]<<8|this.memory[this.pc+1];this.pc+=2;var b=a>>12,c=a>>8&15,d=a>>4&15,e=255&a;switch(b){case 0:this.opcode_0(a);break;case 1:this.pc=4095&a,this.trace("jp 0x"+this.pc.toString(16));break;case 2:this.stack[this.sp++]=this.pc,this.pc=4095&a,this.trace("call 0x"+this.pc.toString(16));break;case 3:this.v[c]==e&&(this.pc+=2),this.trace("se "+this.format_Vx_kk(c,e));break;case 4:this.v[c]!=e&&(this.pc+=2),this.trace("sne "+this.format_Vx_kk(c,e));break;case 5:this.v[c]==this.v[d]&&(this.pc+=2),this.trace("se "+this.format_Vx_Vy(c,d));break;case 6:this.v[c]=e,this.trace("ld "+this.format_Vx_kk(c,e));break;case 7:this.v[c]=this.v[c]+e&255,this.trace("add "+this.format_Vx_kk(c,e));break;case 8:this.opcode_8(a);break;case 9:this.v[c]!=this.v[d]&&(this.pc+=2),this.trace("sne "+this.format_Vx_Vy(c,d));break;case 10:this.i=4095&a,this.trace("ld I, 0x"+this.i.toString(16));break;case 12:this.v[c]=Math.floor(256*Math.random())&e,this.trace("rnd "+this.format_Vx_kk(c,e));break;case 13:this.drawRoutine=function(){var b=15&a;this.v[15]=0;for(var e=0,f=0,g=this.i,h=0;b>h;++h)for(var i=this.memory[g++],j=0;8>j;++j){if(128==(128&i)){e+=1;var k=this.setPixel(this.v[c]+j,this.v[d]+h);k&&(f+=1,this.v[15]=1)}i<<=1}return this.trace("drw V"+c.toString(16)+", V"+d.toString(16)+", 0x"+b.toString(16)),e===f},this.config.drw_waits_for_vsync===!1&&this.performDrawCall();break;case 14:this.opcode_E(a);break;case 15:this.opcode_F(a);break;default:this.opcode_unknown(a)}},a.prototype.format_Vx_kk=function(a,b){return"V"+a.toString(16)+", 0x"+b.toString(16)},a.prototype.format_Vx_Vy=function(a,b){return"V"+a.toString(16)+", V"+b.toString(16)},a.prototype.trace=b!==!1?function(a){for(var b,c="",d=0;d<this.v.length;++d)b=this.v[d].toString(16),c+="V"+d.toString(16)+"="+"00".substr(0,2-b.length)+b,c+=" ";b=this.i.toString(16),c+="I="+"0000".substr(0,4-b.length)+b,Platform.log("["+c+"] "+a)}:function(){},a.prototype.opcode_unknown=function(a){var b="Unsupported opcode encountered: 0x"+a.toString(16);throw Platform.log(b),b},a.prototype.opcode_0=function(a){var b=255&a;switch(b){case 224:this.clearScreen(),this.redraw=!0,this.trace("cls");break;case 238:this.pc=this.stack[--this.sp],this.trace("ret");break;default:this.opcode_unknown(a)}},a.prototype.opcode_8=function(a){var b=a>>8&15,c=a>>4&15,d=15&a;switch(d){case 0:this.v[b]=this.v[c],this.trace("ld "+this.format_Vx_Vy(b,c));break;case 1:this.v[b]=255&(this.v[b]|this.v[c]),this.trace("or "+this.format_Vx_Vy(b,c));break;case 2:this.v[b]=this.v[b]&this.v[c]&255,this.trace("and "+this.format_Vx_Vy(b,c));break;case 3:this.v[b]=255&(this.v[b]^this.v[c]),this.trace("xor "+this.format_Vx_Vy(b,c));break;case 4:var e=this.v[b]+this.v[c];this.v[b]=255&e,this.v[15]=e>255?1:0,this.trace("add "+this.format_Vx_Vy(b,c));break;case 5:this.v[15]=this.v[b]>=this.v[c]?1:0,this.v[b]=this.v[b]-this.v[c]&255,this.trace("sub "+this.format_Vx_Vy(b,c));break;case 6:this.v[15]=1&this.v[b],this.v[b]>>=1,this.trace("shr "+this.format_Vx_Vy(b,c));break;case 7:this.v[15]=this.v[c]>=this.v[b]?1:0,this.v[b]=this.v[c]-this.v[b]&255,this.trace("subn "+this.format_Vx_Vy(b,c));break;case 14:this.v[15]=this.v[b]>>7&1,this.v[b]=this.v[b]<<1&255,this.trace("shl "+this.format_Vx_Vy(b,c));break;default:this.opcode_unknown(a)}},a.prototype.opcode_E=function(a){var b=a>>8&15,c=255&a;switch(c){case 158:this.input.keys[this.v[b]]&&(this.pc+=2),this.trace("skp V"+b.toString(16));break;case 161:this.input.keys[this.v[b]]||(this.pc+=2),this.trace("sknp V"+b.toString(16));break;default:this.opcode_unknown(a)}},a.prototype.opcode_F=function(a){var b=a>>8&15,c=255&a;switch(c){case 7:this.v[b]=this.delayTimer,this.trace("ld V"+b.toString(16)+", DT");break;case 10:this.active=!1,this.trace("ld V"+b.toString(16)+", K");var d=this;this.input.waitForKey(function(a){d.v[b]=a,d.active=!0});break;case 21:this.delayTimer=this.v[b],this.trace("ld DT, V"+b.toString(16));break;case 24:this.soundTimer=this.v[b],this.trace("ld ST, V"+b.toString(16));break;case 30:var e=this.i+this.v[b];this.i=4095&e,this.v[15]=e>4095?1:0,this.trace("add I, V"+b.toString(16));break;case 41:this.i=5*this.v[b],this.trace("ld F, V"+b.toString(16));break;case 51:var f=this.v[b];this.memory[this.i+2]=f%10,f/=10,this.memory[this.i+1]=f%10,f/=10,this.memory[this.i]=f%10,this.trace("ld B, V"+b.toString(16));break;case 85:for(var g=this.i,h=0;b>=h;++h)this.memory[g++]=this.v[h];this.trace("ld [I], V"+b.toString(16));break;case 101:for(var i=this.i,j=0;b>=j;++j)this.v[j]=this.memory[i++];this.trace("ld V"+b.toString(16)+", [I]");break;case 117:for(var k=0;b>=k;++k)this.rpl[k]=this.v[k];this.trace("ld R, V"+b.toString(16));break;case 133:for(var l=0;b>=l;++l)this.v[l]=this.rpl[l];this.trace("ld V"+b.toString(16)+", R");break;default:this.opcode_unknown(a)}},a.prototype.clearScreen=function(){for(var a=0;a<this.vram.length;++a)this.vram[a]=0;this.renderer.clear()},a.prototype.setPixel=function(a,b){if(!(a>=this.screenWidth||b>=this.screenHeight)){var c=b*this.screenWidth+a;return this.vram[c]^=1,1!=this.vram[c]}},window.Chip8=a}(),$(document).ready(main);